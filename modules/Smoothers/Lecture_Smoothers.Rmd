---
title: "Smoothers & Best-Fit Lines"
author: "`r paste('Derek Ogle,',format(Sys.time(),'%B %Y'),sep=' ')`"
output:
  xaringan::moon_reader:
    lib_dir: zlibs
    css: ["zlibs/xaringan-themer.css", "hygge", "ninjutsu"]
    nature:
      ratio: 16:10
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r purler, eval=FALSE, echo=FALSE}
## Use Knit button to make actual slides.
## Makes (Ctrl-S & Ctrl-Alt-C) a script ... will need to edit.
fnm <- "Lecture_Smoothers"
FSA::purl2(file.path(here::here(),"modules/Smoothers",paste0(fnm,".Rmd")),
           moreItems=c("source","setwd","fnm","opts_chunk","flipbookr","cache",
                       "include_graphics","options","splitPerc","leftAssign"))
```


```{r setup, include = FALSE}
source("../zzzflipbook_settings.R")
#!# Loading the tidyverse package (must do every time)
library(tidyverse)
```

class: inverse, center, middle

# Today's Goal

<font size="7">Highligh trends in data with "smoothers" and models (e.g., lines) of best-fit.</font>

---

# Problem Statement

- You may want to draw your audience's attention to the overall trend in a graphic and away from the detail.

&nbsp;

--
- This may be accomplished by adding a "smoother" to the graph.

--
  - **Parametric** ... regression models (lines, polynomials, nonlinear).

--
  - **Non-parameteric** ... LO(W)ESS or GAM smoothers.
    
---

# Linear Regression

- The line that "best fits" a scatterplot of data.

--
- The line out of all possible lines that is "closest" to the data.

--
  - "Closeness" measured by *residual* (vertical distance b/w point and line).

--
  - "Best-fit line" has small sum of squared residuals.

--
```{r echo=FALSE, fig.width=2, fig.height=2, out.width="45%"}
#!# DEREK ... delete this from the script
set.seed(3342374)
df <- data.frame(x=rnorm(15,mean=10,sd=3)) %>%
  mutate(y=3*x+2+rnorm(15,sd=5))

lm1 <- lm(y~x,data=df)

df <- df %>%
  mutate(preds=predict(lm1),
         resid=y-preds)

ggplot(data=df,mapping=aes(x=x,y=y)) +
  geom_point(aes(color=resid>0),size=1.5) +
  geom_segment(mapping=aes(xend=x,yend=preds,color=resid>0),size=0.75,linetype="dashed") +
  geom_smooth(method="lm",se=FALSE,size=1,color="black") +
  scale_x_continuous("Explanatory Variable") +
  scale_y_continuous("Response Variable") +
  scale_color_manual(values=c("FALSE"="red","TRUE"="blue")) +
  theme_bw() +
  theme(legend.position="none",panel.grid=element_blank())
```


---

# LO(W)ESS Smoother

- *LO*cally *WE*ighted *S*catterplot *S*moother.

--
- Details are bit involved (you saw this in the preparation video).

--
  - Essentially fits several regressions to "windows" of data.
  - "Stitches" those together to form a 

--
  - `span=` controls size of windows and, thus, smoothing.

--
```{r echo=FALSE, fig.width=2.75, fig.height=2, out.width="55%"}
#!# DEREK ... delete this from the script
set.seed(334287)
df <- df %>%
  mutate(y2=0.1*x^3-1.8*x^2-1.5*x+150+rnorm(15,sd=10))

ggplot(data=df,mapping=aes(x=x,y=y2/10,color=)) +
  geom_point(size=1.5) +
  geom_smooth(aes(color="0.5"),method="loess",se=FALSE,size=0.75,span=0.5) +
  geom_smooth(aes(color="0.75"),method="loess",se=FALSE,size=0.75,span=0.75) +
  geom_smooth(aes(color="1.5"),method="loess",se=FALSE,size=0.75,span=1.5) +
  scale_color_manual(name="Span",values=c("black","blue","red")) +
  scale_x_continuous("Explanatory Variable") +
  scale_y_continuous("Response Variable") +
  theme_bw() +
  theme(panel.grid=element_blank())
```


---

# GAM

---

# Adding Smoothers

- A "smoother" is added with `geom_smooth()`.

&nbsp;

--
- Type of smoother is chosen with `method=`.

--
  - `method="lm"` ... for a linear regression model.
  - `method="loess"` ... for a loess smoother model (default if n<1000).
  - `method="gam"` ... for a GAM smoother (default if n>1000).

&nbsp;

--
- Specifics of models can be controlled with `se`, `formula=`, `n=`, `span=`.
  - `se=TRUE` ... adds a 95% confidence band (*default*).

--
  - Others are beyond the scope of this class (though we will look at a couple).

---

class: inverse, center, middle

### Linear Regression

---

# Background

- Examine the relationship between the total volume of avocados sold and the average price of an avocado, for *only* organic avocados.

--
- Loaded the data into the `avoc` object.

```{r echo=FALSE}
#!# Load and Prep Data
```
```{r load1, eval=-1}
#!# Set to your own working directory and have just your filename below.
avoc <- read.csv("https://raw.githubusercontent.com/droglenc/NCData/master/Avocados.csv",
                stringsAsFactors=FALSE,quote="") %>%
  filter(region=="GreatLakes",type=="organic") %>%
  mutate(type=factor(type),year=factor(year)) %>%
  select(year,region,Total.Volume,AveragePrice)
head(avoc)
```

---

```{r echo=FALSE}
#!# Exploratory Scatter Plot
```
```{r avoc_scat, include=FALSE}
p <- ggplot(data=avoc,mapping=aes(y=Total.Volume,x=AveragePrice)) +
  geom_point(size=1.25,pch=21,color="black",fill="gray70") +
  scale_x_continuous(name="Average Price ($)") +
  scale_y_continuous(
    breaks=seq(50000,350000,50000),
    labels=scales::unit_format(unit="",scale=1e-3), #BREAK2
    name="Thousands of Bags Sold" #BREAK3
  ) +
  theme_bw() +
  theme(panel.grid.minor=element_blank())
```

`r chunk_reveal("avoc_scat",break_type="non_seq",left_assign=leftAssign,split=splitPerc)`

---

class: inverse, center, middle

### Adding a Regression Line

---

```{r echo=FALSE}
#!# Adding a regression line
```
```{r avoc_lm1, include=FALSE}
p + 
  geom_smooth(
    method="lm", #BREAK2
    color="red", #BREAK3
    fill="red", #BREAK4
    se=FALSE #BREAK5
  )
```

`r chunk_reveal("avoc_lm1",break_type="non_seq",split=splitPerc)`

---

class: inverse, center, middle

### Adding a Regression Line by Group

---

# Create and Show a Palette

```{r echo=FALSE}
#!# create and show a palette
```
```{r}
cbPalette <- c("#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7")
```

--
```{r fig.width=1.5, fig.height=1.5, out.width="45%"}
scales::show_col(cbPalette)
```

---

```{r echo=FALSE}
#!# Adding a regression line for each group
```
```{r avoc_lm2, include=FALSE}
p <- ggplot(data=avoc,mapping=aes(y=Total.Volume,x=AveragePrice,
                                  color=year,fill=year #BREAK2
                                  )) +
  geom_point(size=1.25,pch=21) +
  scale_x_continuous(name="Average Price ($)") +
  scale_y_continuous(name="Thousands of Bags Sold",
                     limits=c(50000,NA),breaks=seq(50000,350000,50000),
                     labels=scales::unit_format(unit="",scale=1e-3)) + 
  geom_smooth(method="lm") +
  scale_color_manual(name="Year",values=cbPalette) + #BREAK3
  scale_fill_manual(name="Year",values=cbPalette) + #BREAK4
  theme_bw() +
  theme(panel.grid.minor=element_blank())
```

`r chunk_reveal("avoc_lm2",break_type="non_seq",left_assign=leftAssign,split=splitPerc)`



---

class: inverse, center, middle

### Loess Smoother

---

# Background

- Examine the trend in Moose (*Alces alces*) aboundance on Isle Royale over time.

--
- Loaded the data into the `irwm` object.

```{r echo=FALSE}
#!# Load and Prep Data
```
```{r load2, eval=-1}
#!# Set to your own working directory and have just your filename below.
irmw <- read.csv("https://raw.githubusercontent.com/droglenc/NCData/master/WolvesMoose_IsleRoyale_June2019.csv",
                 na.strings=c("NA","N/A")) %>%
  select(year,wolves,moose,Jan.Feb..temp..F.,ice.bridges..0.none..1...present.) %>%
  rename(winter_temp=Jan.Feb..temp..F.,
         ice_bridges=ice.bridges..0.none..1...present.) %>%
  mutate(ice_bridges=plyr::mapvalues(ice_bridges,from=c(0,1),to=c("no","yes")),
         ice_bridges=factor(ice_bridges))
head(irmw)
```

---

```{r echo=FALSE}
#!# Exploratory Line Plot
```
```{r moose_scat, include=FALSE}
mw <- ggplot(data=irmw,mapping=aes(y=moose,x=wolves)) +
  geom_point(size=1.25,pch=21,color="black",fill="gray50") +
  scale_x_continuous(name="Number of Wolves") +
  scale_y_continuous(name="Number of Moose") +
  theme_bw() +
  theme(panel.grid.minor=element_blank())
```

`r chunk_reveal("moose_scat",break_type=1,left_assign=leftAssign,split=splitPerc)`

---

class: inverse, center, middle

### Adding a Loess Line

---

```{r echo=FALSE}
#!# Adding a loess line
```
```{r moose_loess1, include=FALSE}
mw + 
  geom_smooth(
    method="loess", #BREAK2
    color="darkorange", #BREAK3
    fill="orange", #BREAK4
    span=0.6 #BREAK5
  )
```

`r chunk_reveal("moose_loess1",break_type="non_seq",split=splitPerc)`

---

```{r moose_loess2, include=FALSE}
mw <- ggplot(data=irmw,mapping=aes(y=moose,x=wolves,
                                   color=ice_bridges,fill=ice_bridges)) +
  geom_point(size=1.25,pch=21) +
  scale_x_continuous(name="Number of Wolves") +
  scale_y_continuous(name="Number of Moose",limits=c(0,NA)) +
  scale_color_manual(name="Ice Bridge?",values=cbPalette) +
  scale_fill_manual(name="Ice Bridge?",values=cbPalette) + 
  geom_smooth(method="loess",span=0.6) +
  theme_bw() +
  theme(panel.grid.minor=element_blank())
```

`r chunk_reveal("moose_loess2",break_type=1,left_assign=leftAssign,split=splitPerc)`

---

class: inverse, center, middle

### User-Defined Models

---






class: inverse, center, middle

# Next Time

<font size="7">XXX.</font>
